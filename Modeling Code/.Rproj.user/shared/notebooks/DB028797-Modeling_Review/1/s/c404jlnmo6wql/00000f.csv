"0","CJS_loglik<-function(beta,cap_X,surv_X,ch){"
"0",""
"0","  #Part 1: Initialize variables"
"0","  xlnlik <- 0"
"0","  nan=nrow(ch)"
"0","  ns=ncol(ch)"
"0","  "
"0","  #Part 2: get locations"
"0","  first<-location(nan,ns,ch)$first"
"0","  last<-location(nan,ns,ch)$last"
"0","  "
"0","  #Part 3: Calculating total log-likelihood"
"0","  for(i in 1:nan){"
"0","    "
"0","    #set initial values"
"0","    sum1=0"
"0","    sum2=0"
"0","    vp_ij<-NA"
"0","    vs_ij<-NA"
"0","    "
"0","    if(first[i]==0){"
"0","      init_cap=ns+1"
"0","      init_surv=ns+1"
"0","    } else if(first[i]>0){"
"0","      init_cap=first[i]"
"0","      init_surv=first[i]-1"
"0","    }"
"0","    "
"0","    #Part 3.1: Compute all probabilities of capturing carcass i,"
"0","    #from first occasion to end"
"0","    if (init_cap<=ns){"
"0","      for (j in init_cap:ns) {"
"0","        vp_ij[j] <- pro_capsur(i,j,ch,beta,cap_X,surv_X)$p.hat"
"0","      }"
"0","    }"
"0","    #Part 3.2:Compute all probabilities of carcass i surviving from j to j+1,"
"0","    #from first occasion to end"
"0","    if(init_surv<ns){"
"0","      for(j in init_surv:(ns-1)){"
"0","        vs_ij[j] <- pro_capsur(i,j,ch,beta,cap_X,surv_X)$s.hat"
"0","      }"
"0","    }"
"0","    "
"0","    #Part 3.3: compute log-likelihood contribution for animal i"
"0","    if((first[i]>0 && first[i]<=last[i])){"
"0","      for(j in first[i]:last[i]){#for each of the observations for the animal,"
"0","                                  #from first contact to last"
"0","       hij <- ifelse(ch[i, j] >= 1, 1, 0)"
"0","        #for each observation, calculate a running sum of"
"0","        #ln(L)=ln(p)+(ln(1-p))+ln(survival)"
"0","        sum1=sum1+hij*log(vp_ij[j])+"
"0","          (1-hij)*log(1-vp_ij[j])+"
"0","          log(vs_ij[j-1])"
"0","      }"
"0","    }"
"0","    "
"0","    #Part 3.4: Find second part of likelihood, Chi"
"0","    #Chi = probability of animal i not being seen again after last i"
"0","    #If animal died on capture before release, prob of not seeing again is 1"
"0","    if(ch[i,last[i]]>=2){"
"0","      sum2=0"
"0","    }else if(last[i]>0 && last[i]<ns){"
"0","      sum2=1-vs_ij[last[i]] #chance it died at last[i]"
"0","      for(ii in (last[i]+1):ns){#for each obs after last[i]"
"0","        prod<-1"
"0","        for(jj in last[i]:(ii-1)){"
"0","          prod<-prod*vs_ij[jj]*(1-vp_ij[jj+1])#product of all chances carcass"
"0","          #survived but wasn't seen for each observation point between"
"0","          #last and ns-1"
"0","        }"
"0","        if(ii<ns){"
"0","          prod<-prod*(1-vs_ij[ii])"
"0","        }"
"0","        sum2<-sum2+prod"
"0","      }"
"0","      sum2<-log(sum2)"
"0","    }"
"0","    "
"0","    #Part 3.5: estimate total likelihood of carcass capture history"
"0","    xlnlik<-xlnlik+sum1+sum2"
"0","  }"
"0","  return(xlnlik)"
"0","}"
